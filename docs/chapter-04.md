
## 4. 좋은 단위 테스트의 4대 요소

* 테스트는 개발 주기에 통합되어야 한다. 
* 실제로 사용하는 테스트에만 가치가 있고, 그렇지 않으면 작성해도 의미가 없다.
* 코드베이스의 가장 중요한 부분만을 대상으로 한다.
* 모든 실행 코드에 똑같이 신경 쓸 필요가 없다.
* 어플리케이션의 핵심(도메인 모델)을 다른 것과 구별하는 것이 중요하다.
* 최소한의 유지비로 최대 가치를 끌어낸다.

가치 있는 테스트를 식별하는 것과 가치 있는 테스트를 작성하는 것은 별개의 기술이다. 
가치 있는 테스트를 작성하려면 가치 있는 테스트 식별이 필요하다. 

### 4.1. 좋은 단위 테스트의 4대 요소 자세히 살펴보기

좋은 단위 테스트에는 네 가지 특성이 있다.

* 회귀 방지
* 리팩토링 내성
* 빠른 피드백
* 유지 보수성

#### 4.1.1. 첫 번째 요소: 회귀 방지

회귀는 코드를 수정한 후 기능이 의도한 대로 작동하지 않는 경우이다. 
즉, 소프트웨어 버그를 의미한다. 
개발할 기능이 많을수록 새로운 릴리즈에서 기능이 고장 날 가능성이 높다. 
코드는 자산이 아니라 책임이다. 
코드 베이스가 커질수록 잠재적인 버그에 더 많이 노출된다. 

회귀 방지 지표에 대한 테스트 점수가 얼마나 잘 나오는지 평가하려면 다음 사항을 고려한다.

* 테스트 중에 실행되는 코드의 양
* 코드 복잡도
* 코드의 도메인 유의성

일반적으로 실행되는 코드가 많을수록 테스트에서 회귀가 나타날 가능성이 높다. 
코드가 예외를 발생시키지 않고 실행된다는 것을 아는 데 도움은 되지만, 코드가 생성하는 결과가 유효한지도 확인해야 한다. 
단순한 코드를 테스트하는 것은 가치가 없다. 
단순한 코드를 다루는 테스트는 실수할 여지가 많지 않아서 회귀 오류가 발생하지 않는다. 
라이브러리, 프레임워크 같이 직접 작성하지 않은 코드에 대한 테스트도 중요하다. 
최상의 보호를 위해선 테스트가 해당 라이브러리, 프레임워크, 외부 시스템을 테스트 범주에 포함시켜서 소프트웨어가 의존성에 대한 검증이 올바른지 확인해야 한다. 
회귀 방지 지표를 극대화하려면 테스트가 가능한 많은 코드를 실행하는 것이 좋다. 

#### 4.1.2. 두 번째 요소: 리팩토링 내성

테스트를 빨간색으로 바꾸지 않고 기본 어플리케이션 코드를 리팩토링할 수 있는지에 대한 척도이다. 
리팩토링은 식별할 수 있는 동작을 수정하지 않고 기존 코드를 변경하는 것이다. 
의도는 코드의 비기능적 특징을 개선하는 것으로 가동성을 높이고 복잡도를 낮추는 것이다. 

* 거짓 양성(false positive)
    * 리팩토링 후 테스트가 실패하지만, 실제 기능은 정상적인 케이스
    * 거짓 양성은 허위 경보
    * 실제 의도한 대로 동작하지만 테스트는 실패하는 결과
    * 구현을 수정하지만 식별할 수 있는 동작은 유지할 때 발생

리팩토링 내성 지표에서 테스트 점수가 얼마나 잘 나오는지 평가하려면 테스트에서 얼마나 많이 거짓 양성이 발생하는지 살펴봐야 한다. 
적을수록 좋다. 
거짓 양성은 전체 테스트 스위트에 치명적인 영향을 준다. 
단위 테스트의 목적은 프로젝트 성장을 지속 가능하게 하는 것이다. 
회귀 없이 주기적으로 리팩토링하고 새로운 기능을 추가할 수 있어야 한다. 

* 기존 기능이 고장 났을 때 테스트가 조기 경고를 제공한다.
* 조기 경고 덕분에 결함이 있는 코드가 운영 환경에 배포되기 훨씬 전에 문제를 해결할 수 있다.
* 운영 환경이었으면 문제를 처리하는데 훨씬 더 많은 노력이 필요하다.
* 코드 변경이 회귀로 이어지지 않을 것이라 확신하게 한다.
* 확신이 없으면 리팩토링을 하는 데 주저하게 되고 코드 베이스가 나빠질 가능성이 높아진다. 

거짓 양성은 위 이점들을 모두 방해한다.

* 테스트가 타당한 이유 없이 실패하면, 코드 문제에 대응하는 능력과 의지가 희석된다. 
* 시간이 흐르면서 실패에 익숙해지고 그만큼 신경을 많이 쓰지 않는다. 
* 타당한 실패도 무시하기 시작하고 기능이 고장나도 운영 환경에 들어가게 된다. 
* 거짓 양성이 빈번하면 테스트 스위트에 대한 신뢰도가 서서히 떨어진다.
* 더 이상 믿을 만한 안전망으로 인식하지 않는다.
* 허의 경보로 인식이 나빠진다.
* 신뢰가 부족해지면 리팩토링이 줄어든다.
* 회귀를 피하려고 코드 변경을 최소한으로 한다.

#### 4.1.3. 무엇이 거짓 양성의 원인인가?

테스트에서 발생하는 거짓 양성의 수는 테스트 구성 방식과 직접적인 관련이 있다. 
테스트와 테스트 대상 시스템의 구현 세부 사항이 많이 결합될수록 허위 경보가 더 많이 생긴다. 
거짓 양성이 생길 가능성을 줄이는 방법은 구현 세부 사항에서 테스트를 분리하는 것 뿐이다. 
테스트를 통해 SUT가 제공하는 최종 결과를 검증해야 한다. 
최종 사용자의 관점에서 SUT를 검증하고 최종 사용자에게 의미 있는 결과만 확인해야 한다. 
다른 모든 것은 무시해야 한다. 

테스트를 구성하기에 가장 좋은 방법은 문제 영역에 대해 이야기하는 것이다. 